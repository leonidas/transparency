<!DOCTYPE html>  <html> <head>   <title>instance.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="attributeFactory.html">                 attributeFactory.coffee               </a>                                           <a class="source" href="context.html">                 context.coffee               </a>                                           <a class="source" href="elementFactory.html">                 elementFactory.coffee               </a>                                           <a class="source" href="helpers.html">                 helpers.coffee               </a>                                           <a class="source" href="instance.html">                 instance.coffee               </a>                                           <a class="source" href="transparency.html">                 transparency.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               instance.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Template <strong>Instance</strong> is created for each model we are about to render.
<code>instance</code> object keeps track of template DOM nodes and elements.
It memoizes the matching elements to <code>queryCache</code> in order to speed up the rendering.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Instance</span>
  <span class="nv">constructor: </span><span class="nf">(template) -&gt;</span>
    <span class="vi">@queryCache = </span><span class="p">{}</span>
    <span class="vi">@childNodes = </span><span class="nx">getChildNodes</span> <span class="nx">template</span>
    <span class="vi">@elements   = </span><span class="nx">getElements</span>   <span class="nx">template</span>

  <span class="nv">remove: </span><span class="nx">chainable</span> <span class="nf">-&gt;</span>
    <span class="k">for</span> <span class="nx">node</span> <span class="k">in</span> <span class="nx">@childNodes</span>
      <span class="nx">node</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">removeChild</span> <span class="nx">node</span>

  <span class="nv">appendTo: </span><span class="nx">chainable</span> <span class="nf">(parent) -&gt;</span>
    <span class="k">for</span> <span class="nx">node</span> <span class="k">in</span> <span class="nx">@childNodes</span>
      <span class="nx">parent</span><span class="p">.</span><span class="nx">appendChild</span> <span class="nx">node</span>

  <span class="nv">prepare: </span><span class="nx">chainable</span> <span class="nf">(model) -&gt;</span>
    <span class="k">for</span> <span class="nx">element</span> <span class="k">in</span> <span class="nx">@elements</span>
      <span class="nx">element</span><span class="p">.</span><span class="nx">reset</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>A bit of offtopic, but let's think about writing event handlers.
It would be convenient to have an access to the associated <code>model</code>
when the user clicks a todo element without setting <code>data-id</code> attributes or other
identifiers manually. So be it.</p>

<pre><code>$('#todos').on('click', '.todo', function(e) {
  console.log(e.target.transparency.model);
});
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">data</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">el</span><span class="p">).</span><span class="nv">model = </span><span class="nx">model</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Rendering values takes care of the most common use cases like
rendering text content, form values and DOM elements (.e.g., Backbone Views).
Rendering as a text content is a safe default, as it is HTML escaped
by the browsers.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">renderValues: </span><span class="nx">chainable</span> <span class="nf">(model, children) -&gt;</span>
    <span class="k">if</span> <span class="nx">isDomElement</span><span class="p">(</span><span class="nx">model</span><span class="p">)</span> <span class="o">and</span> <span class="nv">element = </span><span class="nx">@elements</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="nx">element</span><span class="p">.</span><span class="nx">empty</span><span class="p">().</span><span class="nx">el</span><span class="p">.</span><span class="nx">appendChild</span> <span class="nx">model</span>

    <span class="k">else</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">model</span> <span class="o">==</span> <span class="s">&#39;object&#39;</span>
      <span class="k">for</span> <span class="k">own</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">model</span> <span class="k">when</span> <span class="nx">value</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>The value can be either a nested model or a plain value, i.e., <code>Date</code>, <code>string</code>, <code>boolean</code> or <code>double</code>.
Start by handling the plain values and finding the matching elements.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">isPlainValue</span> <span class="nx">value</span>
          <span class="k">for</span> <span class="nx">element</span> <span class="k">in</span> <span class="nx">@matchingElements</span> <span class="nx">key</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Element type also affects on rendering. Given a model</p>

<pre><code>{todo: 'Do some OSS', type: 2}
</code></pre>

<p><code>div</code> element should have <code>textContent</code> set,
<code>input</code> element should have <code>value</code> attribute set and
with <code>select</code> element, the matching <code>option</code> element should set to <code>selected="selected"</code>.</p>

<pre><code>  &lt;div id="template"&gt;
    &lt;div class="todo"&gt;Do some OSS&lt;/todo&gt;
     &lt;input name="todo" value="Do some OSS" /&gt;
     &lt;select name="type"&gt;
       &lt;option value="1"&gt;Work&lt;/option&gt;
       &lt;option value="2" selected="selected"&gt;Hobby&lt;/option&gt;
     &lt;/select&gt;
  &lt;/div&gt;
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">element</span><span class="p">.</span><span class="nx">render</span> <span class="nx">value</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Rendering nested models breadth-first is more robust, as there might be colliding keys,
i.e., given a model</p>

<pre><code>{
  name: "Jack",
  friends: [
    {name: "Matt"},
    {name: "Carol"}
  ]
}
</code></pre>

<p>and a template</p>

<pre><code>&lt;div id="person"&gt;
  &lt;div class="name"&gt;&lt;/div&gt;
  &lt;div class="friends"&gt;
    &lt;div class="name"&gt;&lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;
</code></pre>

<p>the depth-first rendering might give us wrong results, if the children are rendered
before the <code>name</code> field on the parent model (child template values are overwritten by the parent).</p>

<pre><code>&lt;div id="person"&gt;
  &lt;div class="name"&gt;Jack&lt;/div&gt;
  &lt;div class="friends"&gt;
    &lt;div class="name"&gt;Jack&lt;/div&gt;
    &lt;div class="name"&gt;Jack&lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;
</code></pre>

<p>Save the key of the child model and take care of it once
we're done with the parent model.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">else</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">value</span> <span class="o">==</span> <span class="s">&#39;object&#39;</span>
          <span class="nx">children</span><span class="p">.</span><span class="nx">push</span> <span class="nx">key</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>With <code>directives</code>, user can give explicit rules for rendering and set
attributes, which would be potentially unsafe by default (e.g., unescaped HTML content or <code>src</code> attribute).
Given a template</p>

<pre><code>&lt;div class="template"&gt;
  &lt;div class="escaped"&gt;&lt;/div&gt;
  &lt;div class="unescaped"&gt;&lt;/div&gt;
  &lt;img class="trusted" src="#" /&gt;
&lt;/div&gt;
</code></pre>

<p>and a model and directives</p>

<pre><code>model = {
  content: "&lt;script&gt;alert('Injected')&lt;/script&gt;"
  url: "http://trusted.com/funny.gif"
};

directives = {
  escaped: { text: { function() { return this.content } } },
  unescaped: {Â html: { function() { return this.content } } },
  trusted: { url: { function() { return this.url } } }
}

$('#template').render(model, directives);
</code></pre>

<p>should give the result</p>

<pre><code>&lt;div class="template"&gt;
  &lt;div class="escaped"&gt;&amp;lt;script&amp;gt;alert('Injected')&amp;lt;/script&amp;gt;&lt;/div&gt;
  &lt;div class="unescaped"&gt;&lt;script&gt;alert('Injected')&lt;/script&gt;&lt;/div&gt;
  &lt;img class="trusted" src="http://trusted.com/funny.gif" /&gt;
&lt;/div&gt;
</code></pre>

<p>Directives are executed after the default rendering, so that they can be used for overriding default rendering.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">renderDirectives: </span><span class="nx">chainable</span> <span class="nf">(model, index, directives) -&gt;</span>
    <span class="k">for</span> <span class="k">own</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">attributes</span> <span class="k">of</span> <span class="nx">directives</span> <span class="k">when</span> <span class="k">typeof</span> <span class="nx">attributes</span> <span class="o">==</span> <span class="s">&#39;object&#39;</span>
      <span class="nv">model = </span><span class="p">{</span><span class="nv">value: </span><span class="nx">model</span><span class="p">}</span> <span class="k">unless</span> <span class="k">typeof</span> <span class="nx">model</span> <span class="o">==</span> <span class="s">&#39;object&#39;</span>

      <span class="k">for</span> <span class="nx">element</span> <span class="k">in</span> <span class="nx">@matchingElements</span> <span class="nx">key</span>
        <span class="nx">element</span><span class="p">.</span><span class="nx">renderDirectives</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">attributes</span>

  <span class="nv">renderChildren: </span><span class="nx">chainable</span> <span class="nf">(model, children, directives, options) -&gt;</span>
    <span class="k">for</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">children</span>
      <span class="k">for</span> <span class="nx">element</span> <span class="k">in</span> <span class="nx">@matchingElements</span> <span class="nx">key</span>
        <span class="nx">Transparency</span><span class="p">.</span><span class="nx">render</span> <span class="nx">element</span><span class="p">.</span><span class="nx">el</span><span class="p">,</span> <span class="nx">model</span><span class="p">[</span><span class="nx">key</span><span class="p">],</span> <span class="nx">directives</span><span class="p">[</span><span class="nx">key</span><span class="p">],</span> <span class="nx">options</span>

  <span class="nv">matchingElements: </span><span class="nf">(key) -&gt;</span>
    <span class="nv">elements = </span><span class="nx">@queryCache</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">||=</span> <span class="p">(</span><span class="nx">el</span> <span class="k">for</span> <span class="nx">el</span> <span class="k">in</span> <span class="nx">@elements</span> <span class="k">when</span> <span class="nx">Transparency</span><span class="p">.</span><span class="nx">matcher</span> <span class="nx">el</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
    <span class="nx">log</span> <span class="s">&quot;Matching elements for &#39;</span><span class="si">#{</span><span class="nx">key</span><span class="si">}</span><span class="s">&#39;:&quot;</span><span class="p">,</span> <span class="nx">elements</span>
    <span class="nx">elements</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 